foia_clean2 %>% summarise(groups_added_e = n(fom_rule_type))
foia_clean2 %>% summarise(groups_added_e = n())
foia_clean2 %>% summarise(groups_added_e = n(any(groups_added_e=="employer")))
foia_clean2 %>% summarise(groups_added_e = count(any(groups_added_e=="employer")))
foia_clean2 %>% summarise(groups_added_e = count(any(fom_rule_type=="employer")))
foia_clean2 %>% summarise(groups_added_e = sum(any(fom_rule_type=="employer")))
foia_clean2 %>% summarise(groups_added_e = sum(all(fom_rule_type=="employer")))
foia_clean2 %>% summarise(groups_added_e = sum(fom_rule_type=="employer"))
foia_clean2 %>% summarise(groups_added_e = length(fom_rule_type=="employer"))
foia_clean2 %>% summarise(groups_added_e = length(fom_rule_type=="association"))
foia_clean2 %>% summarise(groups_added_e = sum(fom_rule_type=="association"))
foia_clean2 %>% summarise(groups_added_e = sum(fom_rule_type=="employer"))
foia_clean2 %>% summarise(groups_added_e = all(fom_rule_type=="employer"))
foia_clean2 %>% summarise(groups_added_e = length(which(fom_rule_type=="employer"))
)
foia_clean2 %>% summarise(groups_added_e = length(which(fom_rule_type=="association")))
setwd("C:/Users/Moria/Documents/1 CUCollaborate/CDFI/Greater Nevada")
library(readxl)
library(tidyverse)
library(stringr)
library(writexl)
##LOAD DATA##
cdfi <- read_excel("../Ohio_Valley.xlsx", sheet="CDFI 2015 Data")
loans2020 <- read_excel("GreaterNevadaLoans.xlsx", sheet="2020 Loans", skip=2)
loans2021 <- read_excel("GreaterNevadaLoans.xlsx", sheet="2021 Loans", skip=2)
loans <- rbind(loans2020, loans2021)
geocodio <- read_excel("GreaterNevadaGeocodioRun.xlsx")
#remove calculated fields
cdfi <- select(cdfi, -23)
#remove birthdate column
geocodio <- select(geocodio, -6)
View(geocodio)
colnames(cdfi) <- c("ct2010", "lookup", "ia2015", "state",
"county", "cbsa2015_ind", "pop_total", "pov_perc",
"pov_ind", "mfi", "mfi_cbsa", "mfi_metro_nat",
"mfi_nonmetro_st", "mfi_nonmetro_nat", "mfi_shr", "mfi_ind",
"u_perc", "u_r", "u_ind", "zone_empower_ind",
"pop_r_perc", "pop_loss_ind")
colnames(loans) <- c("analysis_num", "unique_id", "street", "city", "state",
"zip", "loan_date", "loan_amount", "loan_type", "household_income",
"credit_score")
colnames(geocodio) <- c("unique_id", "street", "city", "state" , "zip", "latitude", "longitude",
"accuracy_score", "accuracy_type", "output_number", "output_street",
"unit_type", "unit_number", "output_city", "output_state", "output_county",
"output_zip", "output_country", "source", "census_year", "state_fips", "county_fips",
"place_name", "place_fips", "census_tract_code", "census_block_code",
"census_block_group", "census_block_fips", "census_tract_fips",
"metro_micro_stats_area_name", "metro_micro_stats_area_code", "metro_micro_stats_area_type",
"combined_stats_area_name", "combined_stats_area_code",
"metro_area_name", "metro_area_code")
##REMOVE NA##
geocodio <- geocodio[!is.na(geocodio$unique_id),]
loans <- loans[!is.na(loans$unique_id),]
View(loans)
View(geocodio)
##FORMATTING##
#state
geocodio$state_formatted <- substr(as.character(geocodio$state_fips), 1, 2)
#county
geocodio$county_formatted <- rep("", nrow(geocodio))
for (i in 1:nrow(geocodio)){
c <- as.character(geocodio[i,22])
if (nchar(c)==5){
geocodio[i,38] <- c
}
else if (nchar(c)==4){
geocodio[i,38] <- paste0("0", c)
}
}
#census tract
geocodio$tract_formatted <- rep("", nrow(geocodio))
for (i in 1:nrow(geocodio)){
c <- as.character(geocodio[i,25])
if (nchar(c)==6){
geocodio[i,39] <- c
}
else if (nchar(c)==5){
geocodio[i,39] <- paste0("0", c)
}
else if (nchar(c)==4){
geocodio[i,39] <- paste0("00", c)
}
else if (nchar(c)){
geocodio[i,39] <- paste0("000", c)
}
}
#full tract code
geocodio$full_tract_code <- paste0(geocodio$county_formatted, geocodio$tract_formatted)
##GET MFI BENCHMARK##
cdfi$mfi_benchmark <- rep(0, nrow(cdfi))
for (i in 1:nrow(cdfi)){
area <- cdfi[i,6]
mfi <- cdfi[i,10]
mfi_nonmetro <- cdfi[i,13]
if (area=="Metro"){
cdfi[i,23] <- mfi
}
else {
cdfi[i,23] <- max(mfi, mfi_nonmetro, na.rm=TRUE)
}
}
##COMBINE GEOCODIO AND LOAN DATA##
geocodio2 <- merge(geocodio, loans, by="unique_id")
##CROSS-REFERENCE TABLES##
geocodio2$cdfi_ind <- rep("", nrow(geocodio2))
geocodio2$benchmark_income <- rep(0, nrow(geocodio2))
for (i in 1:nrow(geocodio2)){
full_code <- as.character(geocodio2[i,40])
sub <- cdfi %>% filter(lookup==full_code)
ia_ind <- sub[1,3]
geocodio2[i,51] <- ia_ind
benchmark <- sub[1,23]
geocodio2[i,52] <- benchmark
}
##EVALUATE##
geocodio2$income_perc <- geocodio2$household_income / geocodio2$benchmark_income
geocodio2$low_income <- geocodio2$household_income != 0 & geocodio2$income_perc < 0.8
geocodio2$cdfi_lid <- geocodio2$cdfi_ind=="YES" | geocodio2$low_income==TRUE
##GET COUNTS##
yes <- geocodio2 %>% filter(cdfi_lid==TRUE)
no <- geocodio2 %>% filter(cdfi_lid==FALSE | is.na(cdfi_lid))
yes_counts <- yes %>% summarise(loan_sum = sum(loan_amount),
loan_sum_perc = round(sum(loan_amount)/sum(geocodio2$loan_amount)*100,2),
loan_count = n(),
loan_count_perc = round(n()/nrow(geocodio2)*100, 2))
no_counts <- no %>% summarise(loan_sum = sum(loan_amount),
loan_sum_perc = round(sum(loan_amount)/sum(geocodio2$loan_amount)*100,2),
loan_count = n(),
loan_count_perc = round(n()/nrow(geocodio2)*100, 2))
row_1 <- c("Row Labels", "Sum of Loan Amount", "Sum of Loan Amount (%)", "Count of Loans", "Count of Loans (%)")
row_2 <- c("No", no_counts$loan_sum, no_counts$loan_sum_perc, no_counts$loan_count, no_counts$loan_count_perc)
row_3 <- c("Yes", yes_counts$loan_sum, yes_counts$loan_sum_perc, yes_counts$loan_count, yes_counts$loan_count_perc)
row_4 <- c("GRAND TOTAL", sum(geocodio2$loan_amount), "100.00%", nrow(geocodio2), "100.00%")
table <- as.data.frame(rbind(row_2, row_3, row_4))
names(table) <- row_1
write_xlsx(table, "CDFI_GreaterNevada_output_table.xlsx")
setwd("C:/Users/Moria/Documents/1 CUCollaborate/SEG Analysis 2019")
View(call_report)
library(writexl) #write excel files
View(foia_clean2)
#load packages
library(tidyverse) #data wrangling
library(stringr) #nlp
library(writexl) #write excel files
###PREPARE FOIA DATA###
#load foia data
foia <- read_excel("SEG_Additions_with_2020.xlsx")
#rename columns
colnames(foia) <- c("cu_name", "charter_no", "join_no", "seg_name", "potential_members", "fom_rule", "date")
#make number columns integer format
foia$charter_no <- as.integer(foia$charter_no)
foia$join_no <- as.integer(foia$join_no)
foia$potential_members <- as.integer(foia$potential_members)
#convert date column to date format
foia$date <- as.Date(foia$date, "%Y-%m-%d")
#add year column
foia$year <- as.numeric(format(foia$date, "%Y"))
#add fom rule type
foia_clean2 <- foia_clean %>% mutate(fom_rule_type = case_when(
str_detect(fom_rule, "student") ~ "school",
str_detect(fom_rule, "Student") ~ "school",
str_detect(fom_rule, "studies") ~ "school",
str_detect(fom_rule, "Studies") ~ "school",
str_detect(fom_rule, "employee") ~ "employer",
str_detect(fom_rule, "Employee") ~ "employer",
str_detect(fom_rule, "employed by") ~ "employer",
str_detect(fom_rule, "Employed by") ~ "employer",
str_detect(fom_rule, "member") ~ "association",
str_detect(fom_rule, "Member") ~ "association"
))
foia_summarised <- foia_clean2 %>% group_by(join_no, year) %>% summarise(cu_name = last(cu_name),
num_groups = n(),
total_potential = sum(potential_members, na.rm=TRUE),
num_employers = length(which(fom_rule_type=="employer")),
num_schools = length(which(fom_rule_type=="school")),
num_associations = length(which(fom_rule_type=="association")))
View(foia_summarised)
foia_summarised <- foia_clean2 %>% group_by(join_no, year) %>% summarise(cu_name = last(cu_name),
num_groups = n(),
total_potential = sum(potential_members, na.rm=TRUE),
avg_potential = mean(potential_members, na.rm=TRUE),
num_employers = length(which(fom_rule_type=="employer")),
num_schools = length(which(fom_rule_type=="school")),
num_associations = length(which(fom_rule_type=="association")))
foia_summarised <- foia_clean2 %>% group_by(join_no, year) %>% summarise(cu_name = last(cu_name),
num_groups = n(),
total_potential = sum(potential_members, na.rm=TRUE),
avg_potential = round(mean(potential_members, na.rm=TRUE),0),
num_employers = length(which(fom_rule_type=="employer")),
num_schools = length(which(fom_rule_type=="school")),
num_associations = length(which(fom_rule_type=="association")))
unique(foia_summarised$cu_name)
sort(unique(foia_summarised$cu_name))
q1_2008 <- read.delim("data_call_report/FS220/2008-Q1.txt", header = TRUE, sep = ",", dec = ".")
q2_2008 <- read.delim("data_call_report/FS220/2008-Q2.txt", header = TRUE, sep = ",", dec = ".")
q3_2008 <- read.delim("data_call_report/FS220/2008-Q3.txt", header = TRUE, sep = ",", dec = ".")
q4_2008 <- read.delim("data_call_report/FS220/2008-Q4.txt", header = TRUE, sep = ",", dec = ".")
#2009
q1_2009 <- read.delim("data_call_report/FS220/2009-Q1.txt", header = TRUE, sep = ",", dec = ".")
q2_2009 <- read.delim("data_call_report/FS220/2009-Q2.txt", header = TRUE, sep = ",", dec = ".")
q3_2009 <- read.delim("data_call_report/FS220/2009-Q3.txt", header = TRUE, sep = ",", dec = ".")
q4_2009 <- read.delim("data_call_report/FS220/2009-Q4.txt", header = TRUE, sep = ",", dec = ".")
#2010
q1_2010 <- read.delim("data_call_report/FS220/2010-Q1.txt", header = TRUE, sep = ",", dec = ".")
q2_2010 <- read.delim("data_call_report/FS220/2010-Q2.txt", header = TRUE, sep = ",", dec = ".")
q3_2010 <- read.delim("data_call_report/FS220/2010-Q3.txt", header = TRUE, sep = ",", dec = ".")
q4_2010 <- read.delim("data_call_report/FS220/2010-Q4.txt", header = TRUE, sep = ",", dec = ".")
#2011
q1_2011 <- read.delim("data_call_report/FS220/2011-Q1.txt", header = TRUE, sep = ",", dec = ".")
q2_2011 <- read.delim("data_call_report/FS220/2011-Q2.txt", header = TRUE, sep = ",", dec = ".")
q3_2011 <- read.delim("data_call_report/FS220/2011-Q3.txt", header = TRUE, sep = ",", dec = ".")
q4_2011 <- read.delim("data_call_report/FS220/2011-Q4.txt", header = TRUE, sep = ",", dec = ".")
#2012
q1_2012 <- read.delim("data_call_report/FS220/2012-Q1.txt", header = TRUE, sep = ",", dec = ".")
q2_2012 <- read.delim("data_call_report/FS220/2012-Q2.txt", header = TRUE, sep = ",", dec = ".")
q3_2012 <- read.delim("data_call_report/FS220/2012-Q3.txt", header = TRUE, sep = ",", dec = ".")
q4_2012 <- read.delim("data_call_report/FS220/2012-Q4.txt", header = TRUE, sep = ",", dec = ".")
#2013
q1_2013 <- read.delim("data_call_report/FS220/2013-Q1.txt", header = TRUE, sep = ",", dec = ".")
q2_2013 <- read.delim("data_call_report/FS220/2013-Q2.txt", header = TRUE, sep = ",", dec = ".")
q3_2013 <- read.delim("data_call_report/FS220/2013-Q3.txt", header = TRUE, sep = ",", dec = ".")
q4_2013 <- read.delim("data_call_report/FS220/2013-Q4.txt", header = TRUE, sep = ",", dec = ".")
#2014
q1_2014 <- read.delim("data_call_report/FS220/2014-Q1.txt", header = TRUE, sep = ",", dec = ".")
q2_2014 <- read.delim("data_call_report/FS220/2014-Q2.txt", header = TRUE, sep = ",", dec = ".")
q3_2014 <- read.delim("data_call_report/FS220/2014-Q3.txt", header = TRUE, sep = ",", dec = ".")
q4_2014 <- read.delim("data_call_report/FS220/2014-Q4.txt", header = TRUE, sep = ",", dec = ".")
#2015
q1_2015 <- read.delim("data_call_report/FS220/2015-Q1.txt", header = TRUE, sep = ",", dec = ".")
q2_2015 <- read.delim("data_call_report/FS220/2015-Q2.txt", header = TRUE, sep = ",", dec = ".")
q3_2015 <- read.delim("data_call_report/FS220/2015-Q3.txt", header = TRUE, sep = ",", dec = ".")
q4_2015 <- read.delim("data_call_report/FS220/2015-Q4.txt", header = TRUE, sep = ",", dec = ".")
#2016
q1_2016 <- read.delim("data_call_report/FS220/2016-Q1.txt", header = TRUE, sep = ",", dec = ".")
q2_2016 <- read.delim("data_call_report/FS220/2016-Q2.txt", header = TRUE, sep = ",", dec = ".")
q3_2016 <- read.delim("data_call_report/FS220/2016-Q3.txt", header = TRUE, sep = ",", dec = ".")
q4_2016 <- read.delim("data_call_report/FS220/2016-Q4.txt", header = TRUE, sep = ",", dec = ".")
#2017
q1_2017 <- read.delim("data_call_report/FS220/2017-Q1.txt", header = TRUE, sep = ",", dec = ".")
q2_2017 <- read.delim("data_call_report/FS220/2017-Q2.txt", header = TRUE, sep = ",", dec = ".")
q3_2017 <- read.delim("data_call_report/FS220/2017-Q3.txt", header = TRUE, sep = ",", dec = ".")
q4_2017 <- read.delim("data_call_report/FS220/2017-Q4.txt", header = TRUE, sep = ",", dec = ".")
#2018
q1_2018 <- read.delim("data_call_report/FS220/2018-Q1.txt", header = TRUE, sep = ",", dec = ".")
q2_2018 <- read.delim("data_call_report/FS220/2018-Q2.txt", header = TRUE, sep = ",", dec = ".")
q3_2018 <- read.delim("data_call_report/FS220/2018-Q3.txt", header = TRUE, sep = ",", dec = ".")
q4_2018 <- read.delim("data_call_report/FS220/2018-Q4.txt", header = TRUE, sep = ",", dec = ".")
#2019
q1_2019 <- read.delim("data_call_report/FS220/2019-Q1.txt", header = TRUE, sep = ",", dec = ".")
q2_2019 <- read.delim("data_call_report/FS220/2019-Q2.txt", header = TRUE, sep = ",", dec = ".")
q3_2019 <- read.delim("data_call_report/FS220/2019-Q3.txt", header = TRUE, sep = ",", dec = ".")
q4_2019 <- read.delim("data_call_report/FS220/2019-Q4.txt", header = TRUE, sep = ",", dec = ".")
#2020
q1_2020 <- read.delim("data_call_report/FS220/2020-Q1.txt", header = TRUE, sep = ",", dec = ".")
q2_2020 <- read.delim("data_call_report/FS220/2020-Q2.txt", header = TRUE, sep = ",", dec = ".")
q3_2020 <- read.delim("data_call_report/FS220/2020-Q3.txt", header = TRUE, sep = ",", dec = ".")
q4_2020 <- read.delim("data_call_report/FS220/2020-Q4.txt", header = TRUE, sep = ",", dec = ".")
##SELECT COLUMNS ON INTEREST##
#q1
q1_2008_clean <- q1_2008 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q1_2009_clean <- q1_2009 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q1_2010_clean <- q1_2010 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q1_2011_clean <- q1_2011 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q1_2012_clean <- q1_2012 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q1_2013_clean <- q1_2013 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q1_2014_clean <- q1_2014 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q1_2015_clean <- q1_2015 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q1_2016_clean <- q1_2016 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q1_2017_clean <- q1_2017 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q1_2018_clean <- q1_2018 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q1_2019_clean <- q1_2019 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q1_2020_clean <- q1_2020 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
#q2
q2_2008_clean <- q2_2008 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q2_2009_clean <- q2_2009 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q2_2010_clean <- q2_2010 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q2_2011_clean <- q2_2011 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q2_2012_clean <- q2_2012 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q2_2013_clean <- q2_2013 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q2_2014_clean <- q2_2014 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q2_2015_clean <- q2_2015 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q2_2016_clean <- q2_2016 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q2_2017_clean <- q2_2017 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q2_2018_clean <- q2_2018 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q2_2019_clean <- q2_2019 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q2_2020_clean <- q2_2020 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
#q3
q3_2008_clean <- q3_2008 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q3_2009_clean <- q3_2009 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q3_2010_clean <- q3_2010 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q3_2011_clean <- q3_2011 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q3_2012_clean <- q3_2012 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q3_2013_clean <- q3_2013 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q3_2014_clean <- q3_2014 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q3_2015_clean <- q3_2015 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q3_2016_clean <- q3_2016 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q3_2017_clean <- q3_2017 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q3_2018_clean <- q3_2018 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q3_2019_clean <- q3_2019 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q3_2020_clean <- q3_2020 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
#q4
q4_2008_clean <- q4_2008 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q4_2009_clean <- q4_2009 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q4_2010_clean <- q4_2010 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q4_2011_clean <- q4_2011 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q4_2012_clean <- q4_2012 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q4_2013_clean <- q4_2013 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q4_2014_clean <- q4_2014 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q4_2015_clean <- q4_2015 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q4_2016_clean <- q4_2016 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q4_2017_clean <- q4_2017 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q4_2018_clean <- q4_2018 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q4_2019_clean <- q4_2019 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
q4_2020_clean <- q4_2020 %>% select(CYCLE_DATE, JOIN_NUMBER, ACCT_010, ACCT_083, ACCT_084)
##ADD QUARTER COLUMN##
#2008
q1_2008_clean$year <- "2008"
q2_2008_clean$year <- "2008"
q3_2008_clean$year <- "2008"
q4_2008_clean$year <- "2008"
#2009
q1_2009_clean$year <- "2009"
q2_2009_clean$year <- "2009"
q3_2009_clean$year <- "2009"
q4_2009_clean$year <- "2009"
#2010
q1_2010_clean$year <- "2010"
q2_2010_clean$year <- "2010"
q3_2010_clean$year <- "2010"
q4_2010_clean$year <- "2010"
#2011
q1_2011_clean$year <- "2011"
q2_2011_clean$year <- "2011"
q3_2011_clean$year <- "2011"
q4_2011_clean$year <- "2011"
#2012
q1_2012_clean$year <- "2012"
q2_2012_clean$year <- "2012"
q3_2012_clean$year <- "2012"
q4_2012_clean$year <- "2012"
#2013
q1_2013_clean$year <- "2013"
q2_2013_clean$year <- "2013"
q3_2013_clean$year <- "2013"
q4_2013_clean$year <- "2013"
#2014
q1_2014_clean$year <- "2014"
q2_2014_clean$year <- "2014"
q3_2014_clean$year <- "2014"
q4_2014_clean$year <- "2014"
#2015
q1_2015_clean$year <- "2015"
q2_2015_clean$year <- "2015"
q3_2015_clean$year <- "2015"
q4_2015_clean$year <- "2015"
#2016
q1_2016_clean$year <- "2016"
q2_2016_clean$year <- "2016"
q3_2016_clean$year <- "2016"
q4_2016_clean$year <- "2016"
#2017
q1_2017_clean$year <- "2017"
q2_2017_clean$year <- "2017"
q3_2017_clean$year <- "2017"
q4_2017_clean$year <- "2017"
#2018
q1_2018_clean$year <- "2018"
q2_2018_clean$year <- "2018"
q3_2018_clean$year <- "2018"
q4_2018_clean$year <- "2018"
#2019
q1_2019_clean$year <- "2019"
q2_2019_clean$year <- "2019"
q3_2019_clean$year <- "2019"
q4_2019_clean$year <- "2019"
#2020
q1_2020_clean$year <- "2020"
q2_2020_clean$year <- "2020"
q3_2020_clean$year <- "2020"
q4_2020_clean$year <- "2020"
call_report <- rbind(q1_2008_clean, q2_2008_clean, q3_2008_clean, q4_2008_clean,
q1_2009_clean, q2_2009_clean, q3_2009_clean, q4_2009_clean,
q1_2010_clean, q2_2010_clean, q3_2010_clean, q4_2010_clean,
q1_2011_clean, q2_2011_clean, q3_2011_clean, q4_2011_clean,
q1_2012_clean, q2_2012_clean, q3_2012_clean, q4_2012_clean,
q1_2013_clean, q2_2013_clean, q3_2013_clean, q4_2013_clean,
q1_2014_clean, q2_2014_clean, q3_2014_clean, q4_2014_clean,
q1_2015_clean, q2_2015_clean, q3_2015_clean, q4_2015_clean,
q1_2016_clean, q2_2016_clean, q3_2016_clean, q4_2016_clean,
q1_2017_clean, q2_2017_clean, q3_2017_clean, q4_2017_clean,
q1_2018_clean, q2_2018_clean, q3_2018_clean, q4_2018_clean,
q1_2019_clean, q2_2019_clean, q3_2019_clean, q4_2019_clean,
q1_2020_clean, q2_2020_clean, q3_2020_clean, q4_2020_clean)
View(call_report_sub)
View(call_report)
setwd("C:/Users/Moria/Documents/1 CUCollaborate/CDFI/Rogue")
library(readxl)
library(tidyverse)
library(stringr)
library(writexl)
##LOAD DATA##
cdfi <- read_excel("../Ohio_Valley.xlsx", sheet="CDFI 2015 Data")
loans2020 <- read_excel("RogueLoans.xlsx", sheet="2020 Loans", skip=2)
loans2021 <- read_excel("RogueLoans.xlsx", sheet="2021 Loans", skip=2)
loans <- rbind(loans2020, loans2021)
geocodio <- read_excel("RogueGeocodioRun.xlsx")
#remove calculated fields
cdfi <- select(cdfi, -23)
#rename columns
colnames(cdfi) <- c("ct2010", "lookup", "ia2015", "state",
"county", "cbsa2015_ind", "pop_total", "pov_perc",
"pov_ind", "mfi", "mfi_cbsa", "mfi_metro_nat",
"mfi_nonmetro_st", "mfi_nonmetro_nat", "mfi_shr", "mfi_ind",
"u_perc", "u_r", "u_ind", "zone_empower_ind",
"pop_r_perc", "pop_loss_ind")
colnames(loans) <- c("analysis_num", "unique_id", "street", "city", "state",
"zip", "country", "loan_date", "loan_amount", "loan_type", "household_income",
"credit_score")
colnames(geocodio) <- c("unique_id", "street", "city", "state" , "zip", "country", "latitude", "longitude",
"accuracy_score", "accuracy_type", "output_number", "output_street",
"unit_type", "unit_number", "output_city", "output_state", "output_county",
"output_zip", "output_country", "source", "census_year", "state_fips", "county_fips",
"place_name", "place_fips", "census_tract_code", "census_block_code",
"census_block_group", "census_block_fips", "census_tract_fips",
"metro_micro_stats_area_name", "metro_micro_stats_area_code", "metro_micro_stats_area_type",
"combined_stats_area_name", "combined_stats_area_code",
"metro_area_name", "metro_area_code")
##REMOVE NA##
geocodio <- geocodio[!is.na(geocodio$unique_id),]
loans <- loans[!is.na(loans$unique_id),]
##FORMATTING##
#state
geocodio$state_formatted <- substr(as.character(geocodio$state_fips), 1, 2)
#county
geocodio$county_formatted <- rep("", nrow(geocodio))
for (i in 1:nrow(geocodio)){
c <- as.character(geocodio[i,23])
if (nchar(c)==5){
geocodio[i,39] <- c
}
else if (nchar(c)==4){
geocodio[i,39] <- paste0("0", c)
}
}
#census tract
geocodio$tract_formatted <- rep("", nrow(geocodio))
for (i in 1:nrow(geocodio)){
c <- as.character(geocodio[i,26])
if (nchar(c)==6){
geocodio[i,40] <- c
}
else if (nchar(c)==5){
geocodio[i,40] <- paste0("0", c)
}
else if (nchar(c)==4){
geocodio[i,40] <- paste0("00", c)
}
else if (nchar(c)){
geocodio[i,40] <- paste0("000", c)
}
}
#full tract code
geocodio$full_tract_code <- paste0(geocodio$county_formatted, geocodio$tract_formatted)
##GET MFI BENCHMARK##
cdfi$mfi_benchmark <- rep(0, nrow(cdfi))
for (i in 1:nrow(cdfi)){
area <- cdfi[i,6]
mfi <- cdfi[i,10]
mfi_nonmetro <- cdfi[i,13]
if (area=="Metro"){
cdfi[i,23] <- mfi
}
else {
cdfi[i,23] <- max(mfi, mfi_nonmetro, na.rm=TRUE)
}
}
##COMBINE GEOCODIO AND LOAN DATA##
geocodio2 <- merge(geocodio, loans, by="unique_id")
##CROSS-REFERENCE TABLES##
geocodio2$cdfi_ind <- rep("", nrow(geocodio2))
geocodio2$benchmark_income <- rep(0, nrow(geocodio2))
for (i in 1:nrow(geocodio2)){
full_code <- as.character(geocodio2[i,41])
sub <- cdfi %>% filter(lookup==full_code)
ia_ind <- sub[1,3]
geocodio2[i,53] <- ia_ind
benchmark <- sub[1,23]
geocodio2[i,54] <- benchmark
}
##EVALUATE##
geocodio2$income_perc <- geocodio2$household_income*12 / geocodio2$benchmark_income
geocodio2$low_income <- geocodio2$household_income != 0 & geocodio2$income_perc < 0.8
geocodio2$cdfi_lid <- geocodio2$cdfi_ind=="YES" | geocodio2$low_income==TRUE
##GET COUNTS##
yes <- geocodio2 %>% filter(cdfi_lid==TRUE)
no <- geocodio2 %>% filter(cdfi_lid==FALSE | is.na(cdfi_lid))
yes_counts <- yes %>% summarise(loan_sum = sum(loan_amount),
loan_sum_perc = round(sum(loan_amount)/sum(geocodio2$loan_amount)*100,2),
loan_count = n(),
loan_count_perc = round(n()/nrow(geocodio2)*100, 2))
no_counts <- no %>% summarise(loan_sum = sum(loan_amount),
loan_sum_perc = round(sum(loan_amount)/sum(geocodio2$loan_amount)*100,2),
loan_count = n(),
loan_count_perc = round(n()/nrow(geocodio2)*100, 2))
row_1 <- c("Row Labels", "Sum of Loan Amount", "Sum of Loan Amount (%)", "Count of Loans", "Count of Loans (%)")
row_2 <- c("No", no_counts$loan_sum, no_counts$loan_sum_perc, no_counts$loan_count, no_counts$loan_count_perc)
row_3 <- c("Yes", yes_counts$loan_sum, yes_counts$loan_sum_perc, yes_counts$loan_count, yes_counts$loan_count_perc)
row_4 <- c("GRAND TOTAL", sum(geocodio2$loan_amount), "100.00%", nrow(geocodio2), "100.00%")
table <- as.data.frame(rbind(row_2, row_3, row_4))
names(table) <- row_1
write_xlsx(table, "CDFI_Rogue_output_table.xlsx")
setwd("C:/Users/Moria/tidy-tuesday/2021_Week34")
